import express from 'express';
import { GoogleGenerativeAI } from '@google/generative-ai';
import { db } from '../db/index';
import { aiReports, examAttempts, exams, students, users } from '../db/schema';
import { eq } from 'drizzle-orm';
import { requireAuth } from '../middleware/auth';
import { escapeHtml } from '../utils/helpers';
import { OLGA_REPORT_META_PROMPT_V2 } from '../prompts/olga-report-meta-prompt-v2';

const router = express.Router();

console.log('ğŸ”‘ GEMINI_API_KEY í™•ì¸:', process.env.GEMINI_API_KEY ? 'ì„¤ì •ë¨ âœ…' : 'ì„¤ì • ì•ˆë¨ âŒ');

if (!process.env.GEMINI_API_KEY) {
  console.warn('âš ï¸ GEMINI_API_KEY not set. AI report generation will not work.');
}

const genAI = process.env.GEMINI_API_KEY
  ? new GoogleGenerativeAI(process.env.GEMINI_API_KEY)
  : null;

console.log('ğŸ¤– Gemini ì´ˆê¸°í™”:', genAI ? 'ì„±ê³µ âœ…' : 'ì‹¤íŒ¨ âŒ');

// POST /api/reports/generate/:attemptId - AI ë¶„ì„ ë³´ê³ ì„œ ìƒì„±
router.post('/generate/:attemptId', requireAuth, async (req, res) => {
  try {
    const { attemptId } = req.params;

    // Check if report already exists
    const [existingReport] = await db
      .select()
      .from(aiReports)
      .where(eq(aiReports.attemptId, attemptId))
      .limit(1);

    if (existingReport) {
      console.log('âœ“ ì´ë¯¸ ë³´ê³ ì„œê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ìŠ¤í‚µ:', attemptId);
      return res.status(200).json({
        success: true,
        message: 'ì´ë¯¸ ë³´ê³ ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
        report: existingReport
      });
    }

    // Get attempt with exam and student info
    const [attempt] = await db.select().from(examAttempts).where(eq(examAttempts.id, attemptId)).limit(1);

    if (!attempt || !attempt.submittedAt) {
      return res.status(404).json({ message: 'ì œì¶œëœ ì‹œí—˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    const [exam] = await db.select().from(exams).where(eq(exams.id, attempt.examId)).limit(1);
    const [student] = await db
      .select({
        student: students,
        user: users,
      })
      .from(students)
      .innerJoin(users, eq(students.userId, users.id))
      .where(eq(students.id, attempt.studentId))
      .limit(1);

    if (!exam || !student) {
      return res.status(404).json({ message: 'ì‹œí—˜ ë˜ëŠ” í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    if (!genAI) {
      return res.status(500).json({ message: 'AI ë¶„ì„ ì„œë¹„ìŠ¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' });
    }

    // Prepare data for AI analysis
    const questionsData = exam.questionsData as any[];
    const answers = attempt.answers as any;
    const studentUser = student.user;

    // Calculate domain stats
    const domainMap = new Map<string, { name: string; correct: number; total: number; earnedScore: number; maxScore: number; incorrectQuestions: number[] }>();

    for (const q of questionsData) {
      const domain = q.domain || q.category || 'ë…ì„œ';
      const qNum = q.number || (questionsData.indexOf(q) + 1);
      const studentAnswer = answers[qNum.toString()];
      const isCorrect = studentAnswer === q.correctAnswer;
      const qScore = q.score || 2;

      if (!domainMap.has(domain)) {
        domainMap.set(domain, { name: domain, correct: 0, total: 0, earnedScore: 0, maxScore: 0, incorrectQuestions: [] });
      }

      const domainData = domainMap.get(domain)!;
      domainData.total++;
      domainData.maxScore += qScore;
      if (isCorrect) {
        domainData.correct++;
        domainData.earnedScore += qScore;
      } else {
        domainData.incorrectQuestions.push(qNum);
      }
    }

    const domainStats = Array.from(domainMap.values()).map(d => ({
      ...d,
      percentage: Math.round((d.correct / d.total) * 100),
    }));

    // Get all completed attempts for ranking
    const allAttempts = await db
      .select()
      .from(examAttempts)
      .where(eq(examAttempts.examId, attempt.examId));

    const completedAttempts = allAttempts
      .filter(a => a.score !== null && a.submittedAt !== null);

    const sortedAttempts = completedAttempts
      .sort((a, b) => (b.score || 0) - (a.score || 0));

    const rank = sortedAttempts.findIndex(a => a.id === attemptId) + 1;

    // Call Gemini API with detailed prompt for comprehensive report
    // Try multiple models as fallback
    // GPT-4o ì‚¬ìš©

    // ì·¨ì•½/ê°•ì  ì˜ì—­ ê³„ì‚°
    const weakestArea = domainStats.reduce((min, d) => d.percentage < min.percentage ? d : min, domainStats[0]);
    const strongestArea = domainStats.reduce((max, d) => d.percentage > max.percentage ? d : max, domainStats[0]);

    // ì „ë¬¸ì ì´ê³  ìƒì„¸í•œ í”„ë¡¬í”„íŠ¸ - í‹€ë¦° ë¬¸í•­ íŒ¨í„´ ë¶„ì„
    const incorrectQuestions = questionsData.filter((q: any, idx: number) => {
      const qNum = q.number || (idx + 1);
      return answers[qNum.toString()] !== q.correctAnswer;
    });

    const correctQuestions = questionsData.filter((q: any, idx: number) => {
      const qNum = q.number || (idx + 1);
      return answers[qNum.toString()] === q.correctAnswer;
    });

    // í•™ë…„ë³„ í”„ë¡œê·¸ë¨ ì² í•™
    const gradePhilosophy: { [key: string]: string } = {
      'ì¤‘1': 'ì˜¬ê°€ì˜ ì¤‘1 í”„ë¡œê·¸ë¨ì€ êµ­ì–´ì˜ ê¸°ì´ˆ ê°œë…ì„ íŠ¼íŠ¼íˆ ë‹¤ì§€ëŠ” ë° ì¤‘ì ì„ ë‘¡ë‹ˆë‹¤.',
      'ì¤‘2': 'ì˜¬ê°€ì˜ ì¤‘2 í”„ë¡œê·¸ë¨ì€ ë…í•´ë ¥ê³¼ ë¬¸ë²•ì˜ ì‹¬í™” í•™ìŠµì— ì§‘ì¤‘í•©ë‹ˆë‹¤.',
      'ì¤‘3': 'ì˜¬ê°€ì˜ ì¤‘3 í”„ë¡œê·¸ë¨ì€ ê³ ë“± êµ­ì–´ë¡œì˜ ì „í™˜ì„ ì¤€ë¹„í•˜ë©° ì‹¤ì „ ë…í•´ë¥¼ ê°•í™”í•©ë‹ˆë‹¤.',
      'ê³ 1': 'ì˜¬ê°€ì˜ ê³ 1 í”„ë¡œê·¸ë¨ì€ ìˆ˜ëŠ¥ êµ­ì–´ì˜ ê¸°ë³¸ ì²´ê³„ë¥¼ êµ¬ì¶•í•˜ëŠ” ë° ì§‘ì¤‘í•©ë‹ˆë‹¤.',
      'ê³ 2': 'ì˜¬ê°€ì˜ ê³ 2 í”„ë¡œê·¸ë¨ì€ ìˆ˜ëŠ¥ ë…ì„œ ì§€ë¬¸ ë¶„ì„ê³¼ ë¬¸í•™ ê°ìƒ ëŠ¥ë ¥ì„ ê³ ë„í™”í•©ë‹ˆë‹¤.',
      'ê³ 3': 'ì˜¬ê°€ì˜ ê³ 3 í”„ë¡œê·¸ë¨ì€ ìˆ˜ëŠ¥ ìµœì í™” ì „ëµê³¼ í‚¬ëŸ¬ ë¬¸í•­ ëŒ€ì‘ë ¥ì„ ì™„ì„±í•©ë‹ˆë‹¤.',
    };

    const philosophy = gradePhilosophy[student.student.grade] || 'ì˜¬ê°€ì˜ í”„ë¡œê·¸ë¨ì€ í•™ìƒì˜ ì‹¤ë ¥ í–¥ìƒì— ì§‘ì¤‘í•©ë‹ˆë‹¤.';

    // ===== ìƒˆë¡œìš´ êµ¬ì¡°: System Prompt + User Data ë¶„ë¦¬ =====
    // User Data: Only input data in JSON format (NO old report examples, NO old prompts)
    const userData = {
      studentAnswer: {
        í•™ìƒëª…: studentUser.name,
        í•™ë…„: student.student.grade,
        ì‹œí—˜ëª…: exam.title,
        ì›ì ìˆ˜: attempt.score,
        ë§Œì : attempt.maxScore,
        ì •ë‹µë¥ : Math.round((attempt.score || 0) / (attempt.maxScore || 100) * 100),
        ë“±ê¸‰: attempt.grade,
        ìˆœìœ„: `${rank}/${completedAttempts.length}`,
        í”„ë¡œê·¸ë¨ì² í•™: philosophy,
        ì˜ì—­ë³„ì„±ì·¨ë„: domainStats.map(d => ({
          ì˜ì—­: d.name,
          ì·¨ë“ì ìˆ˜: d.earnedScore,
          ë§Œì : d.maxScore,
          ì •ë‹µìˆ˜: d.correct,
          ì „ì²´ë¬¸í•­: d.total,
          ì •ë‹µë¥ : d.percentage
        }))
      },
      masterCsv: {
        í‹€ë¦°ë¬¸í•­: incorrectQuestions.length > 0 ? incorrectQuestions.map((q: any) => {
          const qNum = q.number || q.questionNumber;
          return {
            ë¬¸í•­ë²ˆí˜¸: qNum,
            ì˜ì—­: q.domain,
            ë‚œì´ë„: q.difficulty || 'ì¤‘',
            ìœ í˜•: q.typeAnalysis || 'ë¯¸ë¶„ë¥˜',
            ì†Œë¶„ë¥˜: q.subcategory || 'ë¯¸ë¶„ë¥˜',
            ì •ë‹µ: q.correctAnswer,
            í•™ìƒë‹µì•ˆ: answers[qNum?.toString()] || 'ë¬´ì‘ë‹µ'
          };
        }) : [],
        ë§ì€ë¬¸í•­: correctQuestions.length > 0 ? correctQuestions.map((q: any) => {
          const qNum = q.number || q.questionNumber;
          return {
            ë¬¸í•­ë²ˆí˜¸: qNum,
            ì˜ì—­: q.domain,
            ë‚œì´ë„: q.difficulty || 'ì¤‘',
            ìœ í˜•: q.typeAnalysis || 'ë¯¸ë¶„ë¥˜',
            ì†Œë¶„ë¥˜: q.subcategory || 'ë¯¸ë¶„ë¥˜'
          };
        }) : []
      },
      average: {
        ì‘ì‹œí•™ìƒìˆ˜: completedAttempts.length,
        ì˜ì—­ë³„í‰ê· : domainStats.map(d => ({
          ì˜ì—­: d.name,
          í‰ê· ì ìˆ˜: Math.round(d.maxScore * 0.65),
          í‰ê· ì •ë‹µë¥ : 65
        }))
      }
    };

    // Combine System Prompt + User Data (clean separation)
    const prompt = `${OLGA_REPORT_META_PROMPT_V2}

[ì…ë ¥ ë°ì´í„°]
${JSON.stringify(userData, null, 2)}`;

    // DEBUG: Log user data structure
    console.log('[DEBUG][USER_DATA]', JSON.stringify(userData, null, 2));
    console.log('[DEBUG][PROMPT_LENGTH]', prompt.length, 'characters');

    // Call Gemini API (Gemini 2.5 Flash)
    console.log('ğŸ¤– Google Gemini 2.5 Flashë¡œ ì „ë¬¸ ë³´ê³ ì„œ ìƒì„± ì¤‘...');

    let responseText = '';

    try {
      if (!genAI) {
        throw new Error('Gemini APIê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }

      const model = genAI.getGenerativeModel({
        model: "gemini-2.5-flash",
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 8000,
        }
      });

      const result = await model.generateContent(prompt);
      const response = result.response;
      responseText = response.text();

      console.log('âœ… Google Gemini ì „ë¬¸ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ');
    } catch (error: any) {
      console.error('âŒ Gemini API ì˜¤ë¥˜:', error.message);
      // AI ë¶„ì„ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë¶„ì„ ë°ì´í„° ìƒì„±
      responseText = JSON.stringify({
        olgaSummary: `AI ë¶„ì„ì´ ì¼ì‹œì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nì„±ì : ${attempt.score}ì /${attempt.maxScore}ì  (${Math.round((attempt.score || 0) / (attempt.maxScore || 100) * 100)}%)\në“±ê¸‰: ${attempt.grade}ë“±ê¸‰\nìˆœìœ„: ${rank}/${completedAttempts.length}`,
        errorPatterns: [],
        subjectAreas: domainStats.map((d: any) => ({
          name: d.name,
          percentage: d.percentage,
          earnedScore: d.earnedScore,
          maxScore: d.maxScore,
          avgScore: 65,
          avgPercentage: 65,
          analysis: `${d.name} ì˜ì—­ì—ì„œ ${d.percentage}%ì˜ ì •ë‹µë¥ ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.`
        }))
      });
    }

    // Parse AI response
    let aiAnalysis: any = {};
    try {
      // Remove markdown code blocks if present (```json ... ```)
      let cleanedText = responseText.trim();
      if (cleanedText.startsWith('```json')) {
        cleanedText = cleanedText.replace(/^```json\s*/i, '').replace(/\s*```$/, '');
      } else if (cleanedText.startsWith('```')) {
        cleanedText = cleanedText.replace(/^```\s*/, '').replace(/\s*```$/, '');
      }

      aiAnalysis = JSON.parse(cleanedText);

      // metaVersion ê²€ì¦
      if (aiAnalysis.metaVersion !== 'v2') {
        console.warn('âš ï¸ ê²½ê³ : ì´ì „ ë²„ì „ì˜ í”„ë¡¬í”„íŠ¸ ì‘ë‹µ ê°ì§€ë¨. metaVersion:', aiAnalysis.metaVersion);
      } else {
        console.log('âœ… ìƒˆë¡œìš´ ë©”íƒ€ í”„ë¡¬í”„íŠ¸ v2 ì‘ë‹µ í™•ì¸');
      }
    } catch (e) {
      console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', e);
      console.error('ì‘ë‹µ ë‚´ìš©:', responseText.substring(0, 500));
      aiAnalysis = {
        metaVersion: 'v2',
        olgaSummary: responseText,
        subjectAreas: [],
        errorPatterns: []
      };
    }

    // ê³„ì‚°ëœ ê°’ë“¤ì„ í…œí”Œë¦¿ìœ¼ë¡œ ìƒì„±
    const percentile = Math.round(100 * (1 - (rank / completedAttempts.length)) * 10) / 10;
    const standardScore = attempt.grade <= 2 ? 80 + (attempt.score / attempt.maxScore) * 20 :
                          attempt.grade <= 4 ? 70 + (attempt.score / attempt.maxScore) * 10 : 'ì¶”ì • ë¶ˆê°€';
    const expectedFinalGrade = attempt.grade <= 2 ? '1~2ë“±ê¸‰' :
                               attempt.grade <= 4 ? '2~3ë“±ê¸‰' : '3~4ë“±ê¸‰';
    const achievementPotential = attempt.grade <= 2 ? 'ë§¤ìš° ë†’ìŒ' :
                                 attempt.grade <= 4 ? 'ë†’ìŒ' : 'ë³´í†µ';

    // í•™ìŠµ ê³„íš í…œí”Œë¦¿ (ê³ ì •)
    const studyPlan = [
      {
        stage: "ì¤‘í•™êµ 3í•™ë…„ - ê¸°ì´ˆ ì²´ë ¥ ì™„ì„± ë‹¨ê³„",
        goal: "ìˆ˜ëŠ¥ êµ­ì–´ì˜ ê¸°ë³¸ í† ëŒ€ êµ¬ì¶•",
        details: "ê°ˆë˜ë³„(í˜„ëŒ€ì‹œ, ê³ ì „ì†Œì„¤ ë“±) ëŒ€í‘œ ì‘í’ˆ ì½ê¸°, ì˜ì—­ë³„(í™”ì‘, ë¬¸ë²•, ë…ì„œ, ë¬¸í•™) ë…í•´ í›ˆë ¨ ì‹œì‘, ì¤‘ë“± ë¬¸ë²• ë§ˆìŠ¤í„°"
      },
      {
        stage: "ê³ ë“±í•™êµ 1í•™ë…„ - ì‹¬í™” í•™ìŠµ ì „ê°œ ë‹¨ê³„",
        goal: "ìˆ˜ëŠ¥ ì¶œì œ íŒ¨í„´ ìµìˆ™í™” ë° ì‹¤ë ¥ ë„ì•½",
        details: "ê³ 1 í•™ë ¥í‰ê°€ ê¸°ì¶œ ì‘í’ˆ/ì§€ë¬¸ ì™„ë²½ ë¶„ì„, ë…í•´ ì „ëµ ìˆ˜ë¦½, ìˆ˜ëŠ¥ ë¬¸ë²• ì „ ì˜ì—­ 1íšŒë… ì™„ë£Œ"
      },
      {
        stage: "ê³ ë“±í•™êµ 2í•™ë…„ - ì‹¤ì „ ì—­ëŸ‰ ê°•í™” ë‹¨ê³„",
        goal: "2ë“±ê¸‰ ì§„ì… ë° 1ë“±ê¸‰ ë„ì „ ê¸°ë°˜ êµ¬ì¶•",
        details: "ê³ 2 í•™ë ¥í‰ê°€ ë° ìˆ˜ëŠ¥ ê¸°ì¶œ(3ê°œë…„) ë¶„ì„, ê³ ë‚œë„ ë…ì„œ ì§€ë¬¸(ê³¼í•™, ê¸°ìˆ , ê²½ì œ) ëŒ€ì‘ í›ˆë ¨, EBS ì—°ê³„ ì‘í’ˆ ì‚¬ì „ í•™ìŠµ"
      },
      {
        stage: "ê³ ë“±í•™êµ 3í•™ë…„ - ìˆ˜ëŠ¥ ì™„ì „ ì •ë³µ ë‹¨ê³„",
        goal: "1ë“±ê¸‰ ì•ˆì •ì  íšë“ ë° ë§Œì  ë„ì „",
        details: "ì£¼ 2íšŒ ì´ìƒ ì‹¤ì „ ëª¨ì˜ê³ ì‚¬, ì·¨ì•½ ì˜ì—­/ìœ í˜• ì§‘ì¤‘ ê³µëµ, EBS ì—°ê³„/ë¹„ì—°ê³„ ê³ ë‚œë„ ë¬¸ì œ í’€ì´, ì‹œê°„ ê´€ë¦¬ ë° ë©˜íƒˆ ê´€ë¦¬ í›ˆë ¨"
      }
    ];

    // í•™ìŠµ ì „ëµ í…œí”Œë¦¿
    const targetIncrease = Math.round(weakestArea.maxScore * 0.2);
    const learningStrategy = [
      {
        stage: "1ë‹¨ê³„<br/>(4ì£¼)",
        focus: `${weakestArea.name} ì§‘ì¤‘ ê³µëµ`,
        details: `${weakestArea.name} ì˜ì—­ì˜ ê¸°ë³¸ ê°œë…ì„ ì™„ë²½íˆ ì´í•´í•˜ê³ , ê´€ë ¨ ë¬¸ì œë¥¼ ë°˜ë³µ í•™ìŠµí•©ë‹ˆë‹¤.`,
        expectedResult: `${weakestArea.name} ì˜ì—­ ì •ë‹µë¥  ${Math.min(weakestArea.percentage + 20, 90)}% ë‹¬ì„±<br/>+${targetIncrease}ì  ìƒìŠ¹`
      },
      {
        stage: "2ë‹¨ê³„<br/>(3ì£¼)",
        focus: "ì „ì²´ ì˜ì—­ ê· í˜• í•™ìŠµ",
        details: "ëª¨ë“  ì˜ì—­ì˜ ê¸°ì¶œ ë¬¸ì œë¥¼ í’€ë©´ì„œ ì•½ì ì„ ë³´ì™„í•˜ê³  ê°•ì ì„ ìœ ì§€í•©ë‹ˆë‹¤.",
        expectedResult: "ì „ì²´ ì˜ì—­ ì •ë‹µë¥  í–¥ìƒ<br/>ì¢…í•© ì•ˆì •ì„± í™•ë³´"
      },
      {
        stage: "3ë‹¨ê³„<br/>(5ì£¼)",
        focus: "ì¢…í•© ì‹¤ì „ ëŒ€ë¹„ ë° ì‹œê°„ ê´€ë¦¬",
        details: "ì£¼ 2íšŒ ì‹¤ì „ ëª¨ì˜ê³ ì‚¬(ì‹œê°„ ì¸¡ì • í•„ìˆ˜), ì˜¤ë‹µ ë¬¸í•­ ì‹¬ì¸µ ë¶„ì„, ì·¨ì•½ ìœ í˜• ì§‘ì¤‘ ë³´ì™„",
        expectedResult: `ì „ì²´ ì •ë‹µë¥  ${Math.min(Math.round((attempt.score || 0) / (attempt.maxScore || 100) * 100) + 10, 95)}% ë‹¬ì„±<br/>${attempt.grade > 1 ? attempt.grade - 1 : 1}ë“±ê¸‰ ì§„ì…`
      }
    ];

    // AIê°€ ìƒì„±í•œ ìƒˆë¡œìš´ JSON êµ¬ì¡° ì²˜ë¦¬
    const aiStats = aiAnalysis.stats || {};
    const aiAnalysisData = aiAnalysis.analysis || {};

    // subjectAreasì— AI ë¶„ì„ ë°ì´í„° í†µí•©
    const enrichedSubjectAreas = domainStats.map((d: any) => {
      const aiSubject = aiAnalysisData.subjectDetails?.find((s: any) => s.name === d.name);
      return {
        name: d.name,
        percentage: d.percentage,
        earnedScore: d.earnedScore,
        maxScore: d.maxScore,
        avgScore: 65,  // í…œí”Œë¦¿ ê°’
        avgPercentage: 65,  // í…œí”Œë¦¿ ê°’
        analysis: aiSubject?.analysisText || `${d.name} ì˜ì—­ì—ì„œ ${d.percentage}%ì˜ ì •ë‹µë¥ ì„ ë³´ì˜€ìŠµë‹ˆë‹¤.`,
        status: aiSubject?.status || (d.percentage >= 80 ? 'ìš°ìˆ˜' : d.percentage >= 60 ? 'ë³´í†µ' : 'ë¶€ì¡±'),
        scoreText: aiSubject?.scoreText || `ì·¨ë“ ${d.earnedScore}ì  / ë§Œì  ${d.maxScore}ì `
      };
    });

    // ê°•ì /ì•½ì  ë¶„ì„
    const strengths = aiAnalysisData.strengths || [];
    const weaknesses = aiAnalysisData.weaknesses || [];

    // ì „ì²´ ë¶„ì„ ë°ì´í„° ì¡°í•©
    const analysisData = {
      overallGrade: attempt.grade,
      rawScore: attempt.score,
      maxScore: attempt.maxScore,
      standardScore,
      percentile,
      expectedFinalGrade,
      subjectAreas: enrichedSubjectAreas,
      olgaSummary: aiAnalysisData.olgaSummary || `${studentUser.name} í•™ìƒì˜ ì„±ì  ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.`,
      errorPatterns: aiAnalysisData.errorPatterns || [],
      strengths,
      weaknesses,
      propensity: aiAnalysisData.propensity || { typeTitle: 'ë¶„ì„ ì¤‘', typeDescription: 'ì„±í–¥ ë¶„ì„ ë°ì´í„°ê°€ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.' },
      studyPlan,
      learningStrategy,
      domainChartData: aiStats.domainChartData || {
        student: domainStats.map(d => d.percentage),
        average: domainStats.map(() => 65)
      },
      predictionScores: [
        attempt.score,
        attempt.score + targetIncrease,
        attempt.score + Math.round(targetIncrease * 1.5),
        Math.min(attempt.score + Math.round(targetIncrease * 2), 100),
        92
      ],
      gradeDistribution: [8, 12, 18, 22, 18, 11, 7, 3, 1],
      percentileDistribution: [3, 5, 8, 12, 15, 18, 16, 13, 7, 3],
      achievementPotential,
      finalMessage: `${studentUser.name} í•™ìƒì€ ë›°ì–´ë‚œ ì ì¬ë ¥ì„ ë³´ì—¬ì£¼ì—ˆìŠµë‹ˆë‹¤. ì œì‹œëœ í•™ìŠµ ì „ëµì„ ì„±ì‹¤íˆ ë”°ë¥¸ë‹¤ë©´ ëª©í‘œ ë“±ê¸‰ ë‹¬ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`,
      recommendations: `${weakestArea.name} ì˜ì—­ì„ ì§‘ì¤‘ì ìœ¼ë¡œ ë³´ì™„í•˜ëŠ” ê²ƒì´ ì„±ì  í–¥ìƒì˜ í•µì‹¬ì…ë‹ˆë‹¤.`,
      domainStats,
      rank,
      totalParticipants: completedAttempts.length,
    };

    // Calculate percentage
    const calculatedPercentage = Math.round(((attempt.score || 0) / (attempt.maxScore || 100)) * 100);

    // Generate HTML content
    const htmlContent = generateReportHTML({
      student: student.user.name,
      grade: student.student.grade || 'ë¯¸ì§€ì •',
      school: student.student.school || 'ë¯¸ì§€ì •',
      examTitle: exam.title,
      examSubject: exam.subject,
      examDate: attempt.submittedAt!,
      score: attempt.score!,
      maxScore: attempt.maxScore!,
      percentage: calculatedPercentage,
      gradeLevel: attempt.grade!,
      analysis: analysisData,
      exam: exam,
      answers: answers,
    });

    // Save report with AI analysis data
    const [report] = await db
      .insert(aiReports)
      .values({
        attemptId,
        studentId: attempt.studentId,
        examId: attempt.examId,
        analysis: analysisData,
        summary: analysisData.olgaSummary || 'ë¶„ì„ ì™„ë£Œ',
        htmlContent,
      })
      .returning();

    res.json({
      success: true,
      report,
    });
  } catch (error) {
    console.error('Generate report error:', error);
    res.status(500).json({ message: 'AI ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// GET /api/reports/:reportId - AI ë³´ê³ ì„œ HTML ì¡°íšŒ
router.get('/:reportId', requireAuth, (req, res) => {
  db.select()
    .from(aiReports)
    .where(eq(aiReports.id, req.params.reportId))
    .limit(1)
    .then(([report]) => {
      if (!report) {
        return res.status(404).send('<h1>ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1>');
      }
      res.setHeader('Content-Type', 'text/html; charset=utf-8');
      res.send(report.htmlContent);
    })
    .catch((error) => {
      console.error('Get report error:', error);
      res.status(500).send('<h1>ë³´ê³ ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</h1>');
    });
});

// GET /api/reports/attempt/:attemptId - ì‘ì‹œ ê¸°ë¡ì˜ ë³´ê³ ì„œ ì¡°íšŒ
router.get('/attempt/:attemptId', requireAuth, async (req, res) => {
  try {
    const [report] = await db
      .select()
      .from(aiReports)
      .where(eq(aiReports.attemptId, req.params.attemptId))
      .limit(1);

    if (!report) {
      return res.status(404).json({ message: 'ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
    }

    res.json({
      success: true,
      data: report,
    });
  } catch (error) {
    console.error('Get report by attempt error:', error);
    res.status(500).json({ message: 'ë³´ê³ ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
  }
});

// Helper function to generate 5-page HTML report with user's exact design template
function generateReportHTML(data: any): string {
  const {
    student,
    grade,
    school,
    examTitle,
    examSubject,
    examDate,
    score,
    maxScore,
    percentage,
    gradeLevel,
    analysis,
    exam,
    answers,
  } = data;

  const dateStr = new Date(examDate).toLocaleDateString('ko-KR');

  // Extract AI analysis data
  const subjectAreas = analysis.subjectAreas || [];
  const strengths = analysis.strengths || [];
  const weaknesses = analysis.weaknesses || [];
  const propensity = analysis.propensity || { typeTitle: 'ë¶„ì„ ì¤‘', typeDescription: 'ì„±í–¥ ë¶„ì„ ë°ì´í„°ê°€ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.' };
  const olgaSummary = analysis.olgaSummary || '';

  // Prepare chart data
  const domainLabels = JSON.stringify(subjectAreas.map((d: any) => d.name));
  const studentPercentages = JSON.stringify(subjectAreas.map((d: any) => d.percentage));
  const avgPercentages = JSON.stringify(subjectAreas.map((d: any) => d.avgPercentage || 65));
  const studentScores = studentPercentages;  // For radar chart
  const averageScores = avgPercentages;  // For radar chart

  // Prediction chart data
  const predictionLabels = JSON.stringify(['í˜„ì¬', '4ì£¼ í›„', '8ì£¼ í›„', '12ì£¼ í›„']);
  const predictionValues = JSON.stringify([percentage, Math.min(percentage + 5, 100), Math.min(percentage + 10, 100), Math.min(percentage + 15, 100)]);

  return `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(examTitle)} - ${escapeHtml(student)} ë¶„ì„ ë³´ê³ ì„œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background: #f1f5f9; }
        .a4-page {
            width: 794px;
            min-height: 1123px;
            background: white;
            margin: 20px auto;
            padding: 60px;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            page-break-after: always;
        }
        .section-title-report {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 4px solid #6366f1;
        }
        @media print {
            body { background: white; }
            .a4-page {
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            .pdf-download-button {
                display: none;
            }
        }

        #pdf-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            text-align: center;
        }
        #pdf-loading-overlay p {
            margin-top: 20px;
            font-size: 1.2em;
            color: white;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4f46e5;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="pdf-loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>PDF íŒŒì¼ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    </div>

    <button id="pdf-download-btn" class="pdf-download-button fixed bottom-8 right-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block -mt-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        PDF ë‹¤ìš´ë¡œë“œ
    </button>

    <section id="report-content">

<!-- í˜ì´ì§€ 1: ì¢…í•© í˜„í™© -->
<div class="page-container page-break">
  <div class="header-gradient"></div>
  <div style="margin-top: 24px;">
    <h1 style="font-size: 28px; font-weight: 900; color: #0f172a; margin-bottom: 8px;">${escapeHtml(examTitle)}</h1>
    <p style="font-size: 14px; color: #64748b; font-weight: 500;">ì˜¬ê°€êµìœ¡ ìˆ˜ëŠ¥ì—°êµ¬ì†Œ Â· AI ê¸°ë°˜ ë§ì¶¤í˜• ì„±ì  ë¶„ì„ ë¦¬í¬íŠ¸</p>
  </div>

  <!-- í•™ìƒ ê¸°ë³¸ ì •ë³´ -->
  <div style="margin-top: 32px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; font-size: 13px;">
      <div><span style="color: #64748b; font-weight: 600;">í•™ìƒëª…</span><br><strong style="color: #0f172a; font-size: 15px;">${escapeHtml(student)}</strong></div>
      <div><span style="color: #64748b; font-weight: 600;">í•™ë…„</span><br><strong style="color: #0f172a; font-size: 15px;">${escapeHtml(grade)}</strong></div>
      <div><span style="color: #64748b; font-weight: 600;">ì‘ì‹œì¼</span><br><strong style="color: #0f172a; font-size: 15px;">${dateStr}</strong></div>
      <div><span style="color: #64748b; font-weight: 600;">ì§€ì </span><br><strong style="color: #0f172a; font-size: 15px;">${escapeHtml(school)}</strong></div>
    </div>
  </div>

  <!-- ì„±ì  ì¢…í•© -->
  <h2 class="section-header">ğŸ“Š ì„±ì  ì¢…í•©</h2>
  <div style="display: flex; gap: 16px; margin-top: 16px;">
    <div style="flex: 1; padding: 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; color: white; text-align: center;">
      <p style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ì¢…í•© ë“±ê¸‰</p>
      <p style="font-size: 56px; font-weight: 900; line-height: 1;">${gradeLevel}</p>
      <p style="font-size: 16px; opacity: 0.9; margin-top: 8px;">ë“±ê¸‰</p>
    </div>
    <div style="flex: 2; padding: 24px; background: white; border: 2px solid #e2e8f0; border-radius: 12px;">
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
        <div>
          <p style="font-size: 12px; color: #64748b; margin-bottom: 8px;">ì›ì ìˆ˜</p>
          <p style="font-size: 24px; font-weight: 700; color: #0f172a;">${score}<span style="font-size: 14px; color: #94a3b8;">/${maxScore}</span></p>
        </div>
        <div>
          <p style="font-size: 12px; color: #64748b; margin-bottom: 8px;">ë°±ë¶„ìœ„</p>
          <p style="font-size: 24px; font-weight: 700; color: #0f172a;">${analysis.percentile || percentage}<span style="font-size: 14px; color: #94a3b8;">%</span></p>
        </div>
        <div>
          <p style="font-size: 12px; color: #64748b; margin-bottom: 8px;">í‘œì¤€ì ìˆ˜</p>
          <p style="font-size: 24px; font-weight: 700; color: #0f172a;">${analysis.standardScore || Math.round(100 + (percentage - 50) * 0.4)}</p>
      </div>
    </div>
  </div>

  <!-- AI ë¶„ì„ ì´í‰ -->
  <h2 class="section-header">ğŸ¯ ì˜¬ê°€ AI ë¶„ì„ ì´í‰</h2>
  <div style="padding: 20px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; font-size: 14px; line-height: 1.8; color: #0f172a;">
    ${olgaSummary ? escapeHtml(olgaSummary) : 'ì˜¬ê°€ AIê°€ í•™ìƒì˜ ì„±ì ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• í•™ìŠµ ì „ëµì„ ì œê³µí•©ë‹ˆë‹¤.'}
  </div>

  <!-- ì˜ì—­ë³„ ë ˆì´ë” ì°¨íŠ¸ -->
  <h2 class="section-header">ğŸ“ˆ ì˜ì—­ë³„ ì„±ì·¨ë„ ë¶„ì„</h2>
  <div style="padding: 20px; background: white; border: 1px solid #e2e8f0; border-radius: 8px;">
    <canvas id="radarChart" class="chart-container"></canvas>
  </div>

  <!-- í˜ì´ì§€ í‘¸í„° -->
  <div style="position: absolute; bottom: 20px; left: 50px; right: 50px; text-align: center; color: #94a3b8; font-size: 11px; border-top: 1px solid #e2e8f0; padding-top: 10px;">
    Â© 2025 ì˜¬ê°€êµìœ¡ ìˆ˜ëŠ¥ì—°êµ¬ì†Œ | AI ê¸°ë°˜ ë§ì¶¤í˜• ë¶„ì„ ë¦¬í¬íŠ¸ | Page 1 / 5
  </div>
</div>

<!-- í˜ì´ì§€ 2: ì˜ì—­ë³„ ìƒì„¸ ë¶„ì„ -->
<div class="page-container page-break">
  <div class="header-gradient"></div>
  <div style="margin-top: 24px;">
    <h1 style="font-size: 22px; font-weight: 800; color: #0f172a;">ğŸ“š ì˜ì—­ë³„ ìƒì„¸ ë¶„ì„</h1>
  </div>

  <h2 class="section-header">ì˜ì—­ë³„ ì„±ì·¨ë„ ìƒì„¸</h2>
  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;">
    ${subjectAreas.map((area: any) => {
      const statusColor = area.status === 'ìš°ìˆ˜' ? '#10b981' : area.status === 'ë³´í†µ' ? '#f59e0b' : '#ef4444';
      return `
    <div style="padding: 16px; background: white; border-left: 4px solid ${statusColor}; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-between; align-items: center; margin-bottom: 12px;">
        <h3 style="font-size: 15px; font-weight: 700; color: #0f172a;">${escapeHtml(area.name)}</h3>
        <span style="font-size: 20px; font-weight: 900; color: ${statusColor};">${area.percentage}%</span>
      </div>
      <p style="font-size: 12px; color: #64748b; margin-bottom: 8px;">${escapeHtml(area.scoreText)}</p>
      <div style="width: 100%; height: 8px; background: #f1f5f9; border-radius: 4px; margin-bottom: 12px; overflow: hidden;">
        <div style="width: ${area.percentage}%; height: 100%; background: ${statusColor};"></div>
      </div>
      <p style="font-size: 13px; line-height: 1.6; color: #334155;">${escapeHtml(area.analysis)}</p>
    </div>
      `;
    }).join('')}
  </div>

  <!-- í˜ì´ì§€ í‘¸í„° -->
  <div style="position: absolute; bottom: 20px; left: 50px; right: 50px; text-align: center; color: #94a3b8; font-size: 11px; border-top: 1px solid #e2e8f0; padding-top: 10px;">
    Â© 2025 ì˜¬ê°€êµìœ¡ ìˆ˜ëŠ¥ì—°êµ¬ì†Œ | AI ê¸°ë°˜ ë§ì¶¤í˜• ë¶„ì„ ë¦¬í¬íŠ¸ | Page 2 / 5
  </div>
</div>

<!-- í˜ì´ì§€ 3: ê°•ì•½ì  ë¶„ì„ ë° ì´í‰ -->
<div class="page-container page-break">
  <div class="header-gradient"></div>
  <div style="margin-top: 24px;">
    <h1 style="font-size: 22px; font-weight: 800; color: #0f172a;">ğŸ’¡ ê°•ì•½ì  ë¶„ì„ ë° í•™ìŠµ ì„±í–¥</h1>
  </div>

  <!-- ê°•ì  ë¶„ì„ -->
  <h2 class="section-header">âœ… ê°•ì  ì˜ì—­</h2>
  <div style="margin-top: 16px; display: grid; gap: 12px;">
    ${strengths.length > 0 ? strengths.map((strength: any) => `
    <div style="padding: 16px; background: #ecfdf5; border-left: 4px solid #10b981; border-radius: 8px;">
      <h3 style="font-size: 14px; font-weight: 700; color: #059669; margin-bottom: 8px;">${escapeHtml(strength.title)}</h3>
      <p style="font-size: 13px; line-height: 1.7; color: #064e3b;">${escapeHtml(strength.description)}</p>
    </div>
    `).join('') : '<p style="font-size: 13px; color: #64748b;">ë¶„ì„ëœ ê°•ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
  </div>

  <!-- ì•½ì  ë¶„ì„ -->
  <h2 class="section-header">âš ï¸ ë³´ì™„ í•„ìš” ì˜ì—­</h2>
  <div style="margin-top: 16px; display: grid; gap: 12px;">
    ${weaknesses.length > 0 ? weaknesses.map((weakness: any) => `
    <div style="padding: 16px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 8px;">
      <h3 style="font-size: 14px; font-weight: 700; color: #dc2626; margin-bottom: 8px;">${escapeHtml(weakness.title)}</h3>
      <p style="font-size: 13px; line-height: 1.7; color: #7f1d1d;">${escapeHtml(weakness.description)}</p>
    </div>
    `).join('') : '<p style="font-size: 13px; color: #64748b;">ë¶„ì„ëœ ì•½ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
  </div>

  <!-- í•™ìŠµ ì„±í–¥ ë¶„ì„ -->
  <h2 class="section-header">ğŸ§  í•™ìŠµ ì„±í–¥ ë¶„ì„</h2>
  <div style="padding: 20px; background: linear-gradient(135deg, #f3e8ff 0%, #e0e7ff 100%); border-radius: 12px; border: 2px solid #a78bfa;">
    <h3 style="font-size: 18px; font-weight: 800; color: #6b21a8; margin-bottom: 12px;">${escapeHtml(propensity.typeTitle)}</h3>
    <p style="font-size: 14px; line-height: 1.8; color: #4c1d95;">${escapeHtml(propensity.typeDescription)}</p>
  </div>

  <!-- í˜ì´ì§€ í‘¸í„° -->
  <div style="position: absolute; bottom: 20px; left: 50px; right: 50px; text-align: center; color: #94a3b8; font-size: 11px; border-top: 1px solid #e2e8f0; padding-top: 10px;">
    Â© 2025 ì˜¬ê°€êµìœ¡ ìˆ˜ëŠ¥ì—°êµ¬ì†Œ | AI ê¸°ë°˜ ë§ì¶¤í˜• ë¶„ì„ ë¦¬í¬íŠ¸ | Page 3 / 5
  </div>
</div>

<!-- í˜ì´ì§€ 4: ë°ì´í„° ë¶„ì„ ë° ë¡œë“œë§µ -->
<div class="page-container page-break">
  <div class="header-gradient"></div>
  <div style="margin-top: 24px;">
    <h1 style="font-size: 22px; font-weight: 800; color: #0f172a;">ğŸ“Š ë°ì´í„° ë¶„ì„ ë° ì„±ì  ë¡œë“œë§µ</h1>
  </div>

  <!-- í•™ìƒ vs í‰ê·  ë¹„êµ ì°¨íŠ¸ -->
  <h2 class="section-header">í•™ìƒ vs ì „ì²´ í‰ê·  ë¹„êµ</h2>
  <div style="padding: 20px; background: white; border: 1px solid #e2e8f0; border-radius: 8px;">
    <canvas id="comparisonChart" class="chart-container"></canvas>
  </div>

  <!-- ì„±ì  ì˜ˆì¸¡ ê·¸ë˜í”„ -->
  <h2 class="section-header">í•™ìŠµ ê³„íšì— ë”°ë¥¸ ì„±ì  ì˜ˆì¸¡</h2>
  <div style="padding: 20px; background: white; border: 1px solid #e2e8f0; border-radius: 8px;">
    <canvas id="predictionChart" class="chart-container"></canvas>
  </div>

  <!-- í˜ì´ì§€ í‘¸í„° -->
  <div style="position: absolute; bottom: 20px; left: 50px; right: 50px; text-align: center; color: #94a3b8; font-size: 11px; border-top: 1px solid #e2e8f0; padding-top: 10px;">
    Â© 2025 ì˜¬ê°€êµìœ¡ ìˆ˜ëŠ¥ì—°êµ¬ì†Œ | AI ê¸°ë°˜ ë§ì¶¤í˜• ë¶„ì„ ë¦¬í¬íŠ¸ | Page 4 / 5
  </div>
</div>

<!-- í˜ì´ì§€ 5: ë§ì¶¤í˜• í•™ìŠµ ì „ëµ -->
<div class="page-container">
  <div class="header-gradient"></div>
  <div style="margin-top: 24px;">
    <h1 style="font-size: 22px; font-weight: 800; color: #0f172a;">ğŸ¯ ë§ì¶¤í˜• í•™ìŠµ ì „ëµ</h1>
  </div>

  <h2 class="section-header">ì£¼ì°¨ë³„ í•™ìŠµ ê³„íš</h2>
  <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 16px;">
    <thead style="background: #f8fafc;">
      <tr>
        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 700; color: #475569; width: 80px;">ì£¼ì°¨</th>
        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 700; color: #475569;">í•µì‹¬ ì „ëµ</th>
        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 700; color: #475569;">ì„¸ë¶€ í•™ìŠµ ë‚´ìš©</th>
        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 700; color: #475569; width: 100px;">ì˜ˆìƒ ì„±ê³¼</th>
      </tr>
    </thead>
    <tbody>
      ${(analysis.learningStrategy || [
        { stage: '1-4ì£¼ì°¨', focus: 'ê¸°ì´ˆ ê°œë… ê°•í™”', details: 'ì˜ì—­ë³„ í•µì‹¬ ê°œë… ë³µìŠµ ë° ì •ë¦¬', expectedResult: '+5%' },
        { stage: '5-8ì£¼ì°¨', focus: 'ì‹¤ì „ ë¬¸ì œ í’€ì´', details: 'ë‹¤ì–‘í•œ ìœ í˜•ì˜ ë¬¸ì œ ì—°ìŠµ', expectedResult: '+8%' },
        { stage: '9-12ì£¼ì°¨', focus: 'ì•½ì  ì§‘ì¤‘ ë³´ì™„', details: 'í‹€ë¦° ë¬¸ì œ ì¬í•™ìŠµ ë° ì•½ì  ì˜ì—­ ê°•í™”', expectedResult: '+12%' }
      ]).map((strategy: any, index: number) => `
      <tr style="border-bottom: 1px solid #f1f5f9;">
        <td style="padding: 12px; color: #334155; font-weight: 700;">${escapeHtml(strategy.stage)}</td>
        <td style="padding: 12px; color: #334155; font-weight: 600;">${escapeHtml(strategy.focus)}</td>
        <td style="padding: 12px; color: #475569;">${escapeHtml(strategy.details)}</td>
        <td style="padding: 12px; color: #10b981; font-weight: 700;">${escapeHtml(strategy.expectedResult)}</td>
      </tr>
      `).join('')}
    </tbody>
  </table>

  <!-- ìµœì¢… ë©”ì‹œì§€ -->
  <div style="margin-top: 32px; padding: 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px; color: white; text-align: center;">
    <h3 style="font-size: 18px; font-weight: 800; margin-bottom: 12px;">ğŸ“ ëª©í‘œ ë‹¬ì„± ê°€ëŠ¥ì„±: ${escapeHtml(analysis.achievementPotential || 'ë†’ìŒ')}</h3>
    <p style="font-size: 14px; line-height: 1.8; opacity: 0.95;">${escapeHtml(analysis.finalMessage || 'ì œì‹œëœ í•™ìŠµ ì „ëµì„ ì¶©ì‹¤íˆ ë”°ë¥¸ë‹¤ë©´ ëª©í‘œ ë“±ê¸‰ ë‹¬ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì˜¬ê°€êµìœ¡ì´ í•¨ê»˜í•©ë‹ˆë‹¤!')}</p>
  </div>

  <!-- í˜ì´ì§€ í‘¸í„° -->
  <div style="position: absolute; bottom: 20px; left: 50px; right: 50px; text-align: center; color: #94a3b8; font-size: 11px; border-top: 1px solid #e2e8f0; padding-top: 10px;">
    Â© 2025 ì˜¬ê°€êµìœ¡ ìˆ˜ëŠ¥ì—°êµ¬ì†Œ | AI ê¸°ë°˜ ë§ì¶¤í˜• ë¶„ì„ ë¦¬í¬íŠ¸ | Page 5 / 5
  </div>
</div>

<script>
  // Page 1: Radar Chart - ì˜ì—­ë³„ ì„±ì·¨ë„ ë¶„ì„
  const radarCtx = document.getElementById('radarChart');
  if (radarCtx) {
    new Chart(radarCtx, {
      type: 'radar',
      data: {
        labels: ${domainLabels},
        datasets: [
          {
            label: 'í•™ìƒ',
            data: ${studentScores},
            borderColor: 'rgb(99, 102, 241)',
            backgroundColor: 'rgba(99, 102, 241, 0.2)',
            borderWidth: 2
          },
          {
            label: 'ì „ì²´ í‰ê· ',
            data: ${averageScores},
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            beginAtZero: true,
            max: 100,
            ticks: {
              stepSize: 20
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          }
        }
      }
    });
  }

  // Page 4: Comparison Chart - í•™ìƒ vs ì „ì²´ í‰ê·  ë¹„êµ
  const comparisonCtx = document.getElementById('comparisonChart');
  if (comparisonCtx) {
    new Chart(comparisonCtx, {
      type: 'bar',
      data: {
        labels: ${domainLabels},
        datasets: [
          {
            label: 'í•™ìƒ',
            data: ${studentScores},
            backgroundColor: 'rgba(99, 102, 241, 0.8)',
            borderColor: 'rgb(99, 102, 241)',
            borderWidth: 1
          },
          {
            label: 'ì „ì²´ í‰ê· ',
            data: ${averageScores},
            backgroundColor: 'rgba(239, 68, 68, 0.6)',
            borderColor: 'rgb(239, 68, 68)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          }
        }
      }
    });
  }

  // Page 4: Prediction Chart - í•™ìŠµ ê³„íšì— ë”°ë¥¸ ì„±ì  ì˜ˆì¸¡
  const predictionCtx = document.getElementById('predictionChart');
  if (predictionCtx) {
    new Chart(predictionCtx, {
      type: 'line',
      data: {
        labels: ${predictionLabels.length > 0 ? predictionLabels : JSON.stringify(['í˜„ì¬', '4ì£¼ í›„', '8ì£¼ í›„', '12ì£¼ í›„'])},
        datasets: [{
          label: 'ì˜ˆìƒ ì„±ì ',
          data: ${predictionValues.length > 0 ? predictionValues : JSON.stringify([percentage, Math.min(percentage + 5, 100), Math.min(percentage + 10, 100), Math.min(percentage + 15, 100)])},
          borderColor: 'rgb(34, 197, 94)',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          }
        }
      }
    });
  }

  // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pages = document.querySelectorAll('.page-container');
    let processedPages = 0;

    // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    document.querySelector('.download-btn').style.display = 'none';

    pages.forEach((page, index) => {
      html2canvas(page, {
        scale: 2,
        useCORS: true,
        logging: false
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210; // A4 width in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        if (index > 0) {
          pdf.addPage();
        }
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

        processedPages++;
        if (processedPages === pages.length) {
          pdf.save('${escapeHtml(student)}_${escapeHtml(examTitle)}_ë¶„ì„ë³´ê³ ì„œ.pdf');
          // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
          document.querySelector('.download-btn').style.display = 'block';
        }
      });
    });
  }
</script>
</body>
</html>`;
}

export default router;
