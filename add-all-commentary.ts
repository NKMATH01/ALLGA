import 'dotenv/config';
import { db } from './server/db/index';
import { exams } from './server/db/schema';
import { eq } from 'drizzle-orm';

async function addAllCommentary() {
  try {
    console.log('🔍 모든 시험 조회...');

    const allExams = await db
      .select()
      .from(exams);

    console.log(`총 ${allExams.length}개의 시험 발견`);

    for (const exam of allExams) {
      console.log(`\n처리 중: ${exam.title}`);

      const questionsData = exam.questionsData as any[];

      if (!questionsData || questionsData.length === 0) {
        console.log('  ⏭️ 문항 데이터 없음');
        continue;
      }

      // 상/최상 난이도 문항에 대한 추가 해설
      const difficultyEnhancements: Record<number, string> = {
        7: `

**[상 난이도 - 복합 정보 해석]**

이 문제는 단순히 글을 읽고 내용을 확인하는 것이 아니라, 여러 시각 자료(그래프, 신문기사, 인터뷰 등)를 통합적으로 해석하고 활용하는 능력을 요구합니다.

**출제 의도:**
- 다양한 자료를 주제에 맞게 선택하고 조합하는 능력
- 각 자료가 글의 논지를 어떻게 뒷받침하는지 파악하는 능력
- 자료의 신뢰성과 타당성을 판단하는 능력

**해결 전략:**
1. 글의 주제를 명확히 파악하기
2. 각 자료가 전달하는 핵심 정보 정리하기
3. 자료 간의 논리적 연결성 확인하기
4. 주제와 무관하거나 논지를 약화시키는 자료 제외하기`,

        12: `

**[상 난이도 - 문법 예외 규정]**

부정어와만 결합하는 용언('안절부절못하다', '시치미떼다' 등)의 특수한 문법적 제약을 이해해야 하는 문제입니다.

**출제 의도:**
- 문법의 기본 규칙뿐만 아니라 예외적인 경우를 정확히 이해하는지 확인
- 부정어와의 결합 양상을 분석하는 능력

**주요 개념:**
- 일부 용언은 부정어 '못'과만 결합 가능 (예: 안절부절못하다)
- 이러한 용언은 '안'과 결합할 수 없음
- 예외 사례를 정확히 구별하는 것이 핵심

**해결 전략:**
1. 제시된 용언이 '안'과 결합 가능한지 확인
2. '못'과만 결합하는 용언인지 판단
3. 실제 사용 예시를 통해 자연스러운지 검증`,

        14: `

**[최상 난이도 - 시제의 특수 용법]**

과거 시제 선어말어미 '-었-'이 문맥에 따라 미래의 일을 확정적으로 표현하는 특수한 용법을 이해해야 하는 고난도 문제입니다.

**출제 의도:**
- 시제 어미의 기본 기능을 넘어선 특수 용법 이해
- 문맥에 따른 시제의 다층적 의미 파악

**핵심 개념:**
- '-었-'의 기본 기능: 과거 시제 표현
- 특수 용법: 미래의 일을 확정적으로 표현 (예: "내일 비 왔어!")
- 화자의 심리적 확신을 나타냄

**해결 전략:**
1. 각 문장의 시간 부사 확인 (어제, 내일, 지금 등)
2. '-었-'이 과거/현재/미래 중 어떤 의미로 쓰였는지 분석
3. 미래 상황을 확정적으로 표현하는 문장 찾기`,

        20: `

**[상 난이도 - 경제 개념의 수리적 적용]**

생산가능곡선 그래프를 해석하고, 기회비용을 직접 계산하여 무역의 이익 발생 조건을 추론하는 복합 사고 문제입니다.

**출제 의도:**
- 그래프 해석 능력
- 기회비용 계산 능력
- 비교 우위 개념의 실제 적용 능력

**해결 전략:**
1. 각국의 생산가능곡선에서 기울기 파악
2. 두 재화 간 기회비용 계산
3. 기회비용이 더 낮은 재화가 비교 우위 재화임을 확인
4. 무역 조건이 양국의 기회비용 사이에 있는지 판단

**계산 팁:**
- A재화 1개 생산의 기회비용 = 포기한 B재화 개수
- 그래프의 기울기 = 기회비용의 비율`,

        24: `

**[최상 난이도 - 철학적 비판적 추론]**

비유적 이야기(장님 코끼리 만지기)를 통해 경험론의 한계를 추론하는 고차원적 사고력 문제입니다.

**출제 의도:**
- 추상적 철학 개념을 구체적 비유와 연결하는 능력
- 이론의 한계점을 비판적으로 파악하는 능력
- 유추적 사고 능력

**핵심 통찰:**
- 경험론: 모든 지식은 감각 경험에서 나온다
- 장님 코끼리 비유: 부분적 경험만으로는 전체를 알 수 없음
- 한계: 경험의 제한성, 해석의 주관성

**해결 전략:**
1. 본문에서 경험론의 핵심 주장 파악
2. <보기>의 비유가 나타내는 문제 상황 이해
3. 비유와 이론의 연결고리 찾기
4. 이론의 어떤 측면이 비판받는지 추론`,

        30: `

**[상 난이도 - 과학 지문의 복합 정보 통합]**

본문의 설명과 그림 자료를 연결하여, 태아의 혈액 순환 과정에 대한 종합적 이해를 요구하는 문제입니다.

**출제 의도:**
- 텍스트와 시각 자료의 통합적 해석
- 과학적 과정에 대한 정확한 이해
- 단계별 인과관계 파악

**해결 전략:**
1. 태아 순환계의 특수 구조 이해 (난원공, 동맥관 등)
2. 그림에서 혈액의 흐름 경로 추적
3. 각 단계에서 산소 농도 변화 파악
4. 폐를 우회하는 경로의 이유 이해

**주의사항:**
- 태아는 폐호흡을 하지 않음 (태반에서 산소 공급)
- 성인과 다른 특수한 혈액 순환 경로 존재`,

        33: `

**[최상 난이도 - 사회 비평적 작품 감상]**

산업화와 농촌 공동체 해체라는 사회적 맥락을 바탕으로 시를 심층적으로 감상하고 비판하는 문제입니다.

**출제 의도:**
- 문학 작품의 사회·역사적 배경 이해
- 외적 준거를 활용한 작품 해석 능력
- 작품과 시대상의 연결고리 파악

**해결 전략:**
1. <보기>에 제시된 시대적 배경 정리
2. 시의 주요 소재와 이미지 분석
3. 시어가 상징하는 사회적 의미 파악
4. 화자의 정서와 시대상의 연결

**감상 포인트:**
- 농촌 공동체의 해체 = 전통적 가치의 상실
- 산업화 = 물질 문명의 확산
- 향수와 그리움 = 상실된 공동체에 대한 그리움`,

        36: `

**[최상 난이도 - 작품의 외적 준거 활용]**

작가의 유배 경험이라는 창작 배경을 바탕으로 시조의 각 구절을 심층적으로 이해하는 문제입니다.

**출제 의도:**
- 작가의 생애와 작품의 연결
- 시대적 상황이 작품에 미친 영향 이해
- 시어의 다층적 의미 해석

**주요 개념:**
- 유배: 정치적 이유로 먼 곳으로 쫓겨남
- 시조에 반영된 억울함, 그리움, 충성심
- 자연 소재의 상징적 의미

**해결 전략:**
1. 유배 상황에서 느낄 감정 추론
2. 각 시어가 작가의 처지와 어떻게 연결되는지 분석
3. 임금에 대한 충성심과 억울함의 표현 찾기
4. 자연물이 상징하는 바 해석

**핵심 감상:**
- 개인적 고통을 넘어선 충의 정신
- 정치적 메시지를 함축한 자연 묘사
- 간접적이고 절제된 감정 표현`
      };

      // Add commentary field to all questions
      const updatedQuestions = questionsData.map((q: any) => {
        const enhancement = difficultyEnhancements[q.number];
        const baseCommentary = q.explanation || '해설이 준비 중입니다.';

        return {
          ...q,
          commentary: enhancement ? baseCommentary + enhancement : baseCommentary
        };
      });

      // Update exam
      await db
        .update(exams)
        .set({
          questionsData: updatedQuestions
        })
        .where(eq(exams.id, exam.id));

      console.log(`  ✅ ${questionsData.length}개 문항 업데이트 완료`);
    }

    console.log('\n🎉 모든 시험 업데이트 완료!');

    process.exit(0);
  } catch (error) {
    console.error('❌ 오류 발생:', error);
    process.exit(1);
  }
}

addAllCommentary();
